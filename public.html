<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Telegram WebApp — Open Notifier</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; }
    .box { border: 1px solid #ddd; padding: 20px; border-radius: 8px; max-width: 720px; margin: auto; }
    pre { white-space: pre-wrap; word-wrap: break-word; background:#f7f7f7; padding:10px; border-radius:6px; }
    button { padding:10px 14px; border-radius:6px; border: none; cursor:pointer; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Включить уведомления в боте</h2>
    <p id="status">Инициализация...</p>
    <pre id="info"></pre>
    <button id="sendBtn">Включить</button>
  </div>

  <script>
    // Проверяем, запущено ли внутри Telegram
    const tg = window.Telegram ? window.Telegram.WebApp : (window.TelegramWebviewProxy ? window.TelegramWebviewProxy : null);
    // На практике, Telegram предоставляет window.Telegram.WebApp
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    const sendBtn = document.getElementById('sendBtn');

    function show(msg) {
      statusEl.textContent = msg;
    }

    function postData(payload) {
      return fetch('/opened', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r => r.json());
    }

    // parse init data
    const initData = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData ? window.Telegram.WebApp.initData : (window.TelegramInitData || '');
    // Telegram also exposes parsed data as initDataUnsafe
    const initDataUnsafe = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe ? window.Telegram.WebApp.initDataUnsafe : (window.TelegramInitDataUnsafe || {});

    async function sendOpenNotify() {
      try {
        const resp = await postData({ initData: initData || '', initDataUnsafe: initDataUnsafe || {} });
        infoEl.textContent = 'Ответ сервера: ' + JSON.stringify(resp, null, 2);
        show('Готово — информация отправлена.');
      } catch (err) {
        infoEl.textContent = String(err);
      }
    }

    // Автоматически отправляем при загрузке (если есть данные)
    window.addEventListener('load', async () => {
      show('Готово. Собираю данные...');
      infoEl.textContent = `initData: ${initData}\n\ninitDataUnsafe: ${JSON.stringify(initDataUnsafe, null, 2)}`;
      // Попробуем отправить автоматически (зависит от вашего желания)
      await sendOpenNotify();
    });

    sendBtn.addEventListener('click', sendOpenNotify);
  </script>
</body>
</html>
