<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Telegram WebApp — Send Data</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--muted:#666;--accent:#2b8cff}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:820px;margin:28px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 14px;color:var(--muted)}
    pre{background:#f5f7fb;padding:12px;border-radius:8px;overflow:auto;max-height:360px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(43,140,255,.15)}
    .small{font-size:13px;color:var(--muted);margin-top:8px}
    .warning{color:#b33;margin-top:10px}
    .ok{color:green}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Telegram Web App — отправка данных боту</h1>
      <p class="lead">Откройте эту страницу <strong>только</strong> из Telegram (через кнопку WebApp у бота). После подтверждения данные будут отправлены боту через <code>Telegram.WebApp.sendData()</code>.</p>

      <div id="status" class="muted">Инициализация...</div>
      <div class="small" id="hint"></div>

      <label style="display:block;margin-top:12px">Preview (данные):</label>
      <pre id="preview">—</pre>

      <div class="row">
        <button id="sendBtn" disabled>Отправить данные боту</button>
        <button id="refreshBtn" class="ghost">Обновить preview</button>
        <button id="closeBtn" class="ghost">Закрыть</button>
      </div>

      <div id="info" class="small" style="margin-top:10px">
        <div>Перед отправкой вы видите, какие поля будут переданы. Телефон/email <strong>не передаются</strong> без Login Widget.</div>
      </div>

      <div id="warning" class="warning" style="display:none"></div>
    </div>
  </div>

<script>
(function(){
  const statusEl = id => document.getElementById('status').innerText = id;
  const hintEl = id => document.getElementById('hint').innerText = id;
  const previewEl = obj => document.getElementById('preview').innerText = JSON.stringify(obj, null, 2);
  const sendBtn = document.getElementById('sendBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const closeBtn = document.getElementById('closeBtn');
  const warningEl = document.getElementById('warning');

  function bytesLen(str){
    try {
      return (new TextEncoder()).encode(str).length;
    } catch(e) {
      // fallback
      return unescape(encodeURIComponent(str)).length;
    }
  }

  function preparePayload(tg){
    const initUnsafe = tg.initDataUnsafe || {};
    const initSigned = tg.initData || null;
    const payload = {
      _sent_at: new Date().toISOString(),
      user: initUnsafe.user || null,
      chat: initUnsafe.chat || null,
      start_param: initUnsafe.start_param || null,
      auth_date: initUnsafe.auth_date || null,
      query_id: initUnsafe.query_id || null,
      initData: initSigned ? "<signed_present>" : null,
      client: {
        platform: tg.platform || null,
        color_scheme: tg.colorScheme || null,
        viewport: {h: tg.viewportHeight, stableH: tg.viewportStableHeight}
      },
      ua: navigator.userAgent
    };
    return payload;
  }

  if(!window.Telegram || !window.Telegram.WebApp){
    statusEl('⚠️ Telegram WebApp NOT FOUND');
    hintEl('Откройте этот URL внутри Telegram (через кнопку WebApp у бота). В обычном браузере данные недоступны.');
    previewEl({note: 'Open inside Telegram via bot WebApp button.'});
    sendBtn.disabled = true;
    refreshBtn.addEventListener('click', ()=>location.reload());
    closeBtn.addEventListener('click', ()=>window.close());
    return;
  }

  const tg = window.Telegram.WebApp;
  try { tg.ready(); } catch(e){ console.warn('tg.ready() failed', e); }

  statusEl('✅ Telegram WebApp detected');
  hintEl('Проверьте preview и нажмите "Отправить данные боту".');

  function updatePreview(){
    try {
      const payload = preparePayload(tg);
      previewEl(payload);
      const s = JSON.stringify(payload);
      const len = bytesLen(s);
      if(len > 4000){
        warningEl.style.display = 'block';
        warningEl.innerText = `⚠️ Payload ~${len} bytes — это близко или выше лимита sendData (~4096). При отправке мы автоматически сократим payload.`;
      } else {
        warningEl.style.display = 'none';
      }
    } catch(e){
      console.error('preview error', e);
    }
  }

  updatePreview();
  sendBtn.disabled = false;

  refreshBtn.addEventListener('click', updatePreview);

  sendBtn.addEventListener('click', function(){
    try {
      let payload = preparePayload(tg);
      let s = JSON.stringify(payload);
      const len = bytesLen(s);
      if(len > 4000){
        // aggressively trim non-essential fields
        payload = {
          _sent_at: payload._sent_at,
          user: payload.user,
          chat: payload.chat,
          initData: payload.initData ? "<signed_present>" : null,
          client: payload.client
        };
        s = JSON.stringify(payload);
      }

      if(typeof tg.sendData === 'function'){
        tg.sendData(s);
        statusEl('✅ Данные отправлены боту (tg.sendData).');
        previewEl(payload);
        // auto close
        setTimeout(()=>{ try{ tg.close(); } catch(e){} }, 700);
      } else {
        statusEl('❌ tg.sendData отсутствует в этой среде.');
        hintEl('Убедитесь, что WebApp открыт через кнопку WebApp у бота и клиент Telegram актуален.');
      }
    } catch(err){
      console.error('send error', err);
      statusEl('Ошибка отправки: ' + String(err));
    }
  });

  closeBtn.addEventListener('click', ()=>{ try{ tg.close(); } catch(e){ window.close(); } });

  // debug: log initData to console for inspection
  try { console.info('initDataUnsafe:', tg.initDataUnsafe); } catch(e){}
})();
</script>
</body>
</html>

